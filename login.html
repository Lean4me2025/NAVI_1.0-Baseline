<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login</title>
  <link rel="stylesheet" href="assets/styles.css" />
  <script type="module">
    
    import { setupOrVerifyPIN, setSession, currentUserEmail, restoreIfAny, wipeAccount } from './assets/app.js';
    function accountExists(email){
      try { return !!JSON.parse(localStorage.getItem('navi_account_' + email) || 'null'); } catch { return false; }
    }
    function checkEmail(){
      const email = document.getElementById('email').value.trim().toLowerCase();
      const banner = document.getElementById('firstTimeBanner');
      const pinHelp = document.getElementById('pinHelp');
      if(!email) { banner.style.display = 'none'; pinHelp.textContent = 'Enter your PIN.'; return; }
      if(accountExists(email)){
        banner.style.display = 'none';
        pinHelp.textContent = 'Enter your existing PIN for this email.';
      } else {
        banner.style.display = 'block';
        pinHelp.textContent = 'Create a new 4–6 digit PIN for this email.';
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      const cur = currentUserEmail();
      const emailEl = document.getElementById('email');
      if(cur){ emailEl.value = cur; }
      emailEl.addEventListener('input', checkEmail);
      checkEmail();
    });
    window.doLogin = async () => {
      const email = document.getElementById('email').value.trim().toLowerCase();
      const pin = document.getElementById('pin').value.trim();
      if(!email || !email.includes('@')) { alert('Enter a valid email.'); return; }
      if(!pin || pin.length < 4){ alert('Enter a PIN (min 4 digits).'); return; }
      const res = await setupOrVerifyPIN(email, pin);
      if(!res.ok){
        alert('PIN incorrect for this email.');
        return;
      }
      setSession(email);
      // Try restore
      await restoreIfAny();
      if(document.getElementById('firstTimeBanner').style.display === 'block'){
        alert('PIN created. Keep it private — you will need it to unlock your data.');
      }
      window.location.href = 'dashboard.html';
    };
    window.doWipe = () => {
      const email = document.getElementById('email').value.trim().toLowerCase();
      if(!email){ alert('Enter the email to wipe.'); return; }
      if(confirm('This will erase the saved session for this email on this device. Proceed?')){
        wipeAccount(email);
        alert('Account data wiped for this device.');
      }
    };
  </script>
<script type="module">import { logout } from './assets/app.js'; window.logout = logout;</script>
</head>
<body>
  <header class="site">
    <h1>Login</h1>
    <p class="notice" id="firstTimeBanner" style="display:none; margin-top:10px;">First time on this device? Create a 4–6 digit PIN now. You’ll need it to unlock your data next time.</p>
    <p>Email + PIN keeps your info private on shared computers.</p>
  </header>
  <main class="container">
    <div class="card">
      <label>Email</label>
      <input id="email" type="email" placeholder="you@example.com" style="width:100%; padding:12px; margin-top:6px; border:1px solid #e7eaf0; border-radius:10px;">
      <div style="height:8px"></div>
      <label>PIN (4–6 digits)</label>
      <input id="pin" type="password" inputmode="numeric" pattern="\d*" maxlength="6" placeholder="••••" style="width:200px; padding:12px; margin-top:6px; border:1px solid #e7eaf0; border-radius:10px;">
      <div class="small" id="pinHelp" style="margin-top:6px;">Enter your PIN.</div>
      <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
        <button class="btn" onclick="doLogin()">Continue</button>
        <a class="btn secondary" href="index.html">Cancel</a>
        <button class="btn secondary" onclick="doWipe()">Forgot PIN? Wipe &amp; reset</button>
      </div>
      <hr class="sep" />
      <div class="notice">
        This protects your session on this device by encrypting your data with your PIN. If you forget the PIN, you can wipe and start fresh.
        For cross-device login, use a backend (see README).
      </div>
    </div>
  </main>
</body>
</html>
